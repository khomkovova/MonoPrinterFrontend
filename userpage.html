<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>DrukBox</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <!-- <link rel="stylesheet" type="text/css" href="/libs/semantic/semantic.css">
    <script src="/libs/semantic/semantic.js"></script> -->
    <!-- MDB -->
    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous">
    </script>
    <!-- Font Awesome -->
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js" integrity="sha256-VBLiveTKyUZMEzJd6z2mhfxIqz3ZATCuVMawPZGzIfA=" crossorigin="anonymous"></script>
    <!-- Tempus Dominus Bootstrap 4 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/css/tempusdominus-bootstrap-4.min.css" integrity="sha256-XPTBwC3SBoWHSmKasAk01c08M6sIA5gF5+sRxqak2Qs=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/js/tempusdominus-bootstrap-4.min.js" integrity="sha256-z0oKYg6xiLq3yJGsp/LsY9XykbweQlHl42jHv2XTBz4=" crossorigin="anonymous"></script>
    <!-- pickadate -->
    <link rel="stylesheet" href="/public/html/pt/themes/default.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="/public/html/pt/themes/default.date.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="/public/html/pt/themes/default.time.css" crossorigin="anonymous" />
    <link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/carousel/">
    <link href="/public/css/carosel.css" rel="stylesheet">
    <link href="/public/css/footer.css" rel="stylesheet">
    <script src="/public/html/pt/picker.js" crossorigin="anonymous"></script>
    <script src="/public/html/pt/picker.time.js" crossorigin="anonymous"></script>
    <script src="/public/html/pt/picker.date.js" crossorigin="anonymous"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand text-success" href="index.html">DrukBox</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="userpage.html">Print File <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="history.html">History</a>
                </li>
                <!--                 <li class="nav-item active">
                    <a class="nav-link" href="delete_file.html">Delete File</a>
                </li> -->
                <li class="nav-item active">
                    <a class="nav-link" href="add_pages.html">Add pages</a>
                </li>
            </ul>
            <div class=" navbar-nav nav-item dropdown ">
                <a class="nav-link dropdown-toggle btn btn-outline-success" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    User
                    <i class="fa fa-user"></i></a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                    <ul class="list-group list-group-flush" id="user-info-dropmenu">
                        <li class="list-group-item">
                            <a class="text-secondary" onclick="return logOut();" href="index.html">Log out</a>
                        </li>
                        <li class="list-group-item">
                            <a class="text-secondary" href="signin.html">Sign In</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    <div id="wrap">
        <div id="main">
            <div class="container ">
                <div class="row">
                    <div class="col-sm-6" style="margin:0 auto">
                        <br>
                        <div class="card">
                            <h3 class="display-6  card-header info-color text-center py-4">New file</h3>
                            <div class="card-body">
                                <div class="form-group">
                                    <div class="alert alert-info" role="alert" id="pages-message"> </div>
                                    <div class="alert alert-warning" role="alert" id="info-message">Price 1 page - 1 UAH<br>File should have minimum 5 pages and maximum 15 pages<br>Please check your file before click button "Submit" because then you can't cancel your order</div>
                                    <br>
                                    <div class="d-flex justify-content-center">
                                        <div class="col-md-3 col-sm-6" id="timer-bar">
                                        </div>
                                    </div>
                                    <div class="field">
                                        <div class="input-group date  btn-file">
                                            <input type="text" id="_attachmentName" class="form-control datetimepicker-input">
                                            <div class="input-group-append">
                                                <label for="attachmentName" class="input-group-text">
                                                    <i class="fa fa-paperclip fa-1.2x" aria-hidden="true"></i>
                                                    <input type="file" id="attachmentName" name="attachmentName" style="display: none">
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <br>
                                    <select class="browser-default custom-select" id="terminal-list">
                                        <option value="1" selected>Select terminal for printing</option>
                                        <option value="1" type="number">1</option>
                                    </select>
                                    <br>
                                    <br>
                                    <form>
                                        <fieldset>
                                            <input id="input_from time-picker" class="datepicker custom-select" type="time" name="time">
                                        </fieldset>
                                    </form>
                                    <br>
                                    <br>
                                    <button type="button" value="Submit" class="btn btn-dark " onClick="submit_form()">Submit</button>
                                    <br>
                                    <br>
                                    <div class="alert alert-danger" role="alert" id="error-message"> </div>
                                    <div class="alert alert-success" role="alert" id="success-message"> </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-8 col-sm-6 col-xs-12">
                    <p class="copyright-text">Copyright &copy; 2020 All Rights Reserved by
                        <a href="policy.html">DrukBox</a>.
                    </p>
                </div>
                <div class="col-md-4 col-sm-6 col-xs-12">
                    <ul class="social-icons">
                        <li><a class="facebook" href="#"><i class="fa fa-facebook"></i></a></li>
                        <li><a class="twitter" href="#"><i class="fa fa-twitter"></i></a></li>
                        <li><a class="dribbble" href="#"><i class="fa fa-dribbble"></i></a></li>
                        <li><a class="linkedin" href="#"><i class="fa fa-linkedin"></i></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <!-- </div> -->
    <script>
    function sleep(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
    }

    function logOut() {
        var cookies = document.cookie.split(";");

        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i];
            var eqPos = cookie.indexOf("=");
            var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
        }
    }


    function start_timer_bar() {

        $("#timer-bar").html('<div class="progress blue"> <span class="progress-left"> <span class="progress-bar"> </span> </span> <span class="progress-right"> <span class="progress-bar"> </span> </span> <div class="progress-value" id="timer_bar_value"> 1</div> </div>');
        var counter = 1;
        var interval = setInterval(function() {
            counter++;
            // Display 'counter' wherever you want to display it.
            if (counter >= 30) {
                clearInterval(interval);
                set_error_message("Time out, please ckeck your file")
                delete_timer_bar()
                return;
            } else {
                try {
                    var v = document.getElementById("timer_bar_value")
                    console.log(counter)
                    v.innerHTML = counter
                } catch (e) {
                    console.log(e)
                    clearInterval(interval);
                    return
                }

            }
        }, 1000);
    }

    function delete_timer_bar() {
        var m = document.getElementById("timer-bar")
        m.innerHTML = '';
    }

    function set_success_message(text) {
        var m = document.getElementById("success-message")
        m.style.visibility = "visible";
        if (text == "") {
            m.style.visibility = "hidden";
        }
        m.innerHTML = text;

    }

    function setup_time_picker(busy_time) {
        // var busy_time  = ["2019-12-02T22:45:36", "2019-12-02T22:48:36"]
        // var busy_time  = get_busy_time()
        var picker = ""
        var busy_date = new Array();

        function addMinutes(date, minutes) {
            return new Date(date.getTime() + minutes * 60000);
        }
        for (var i = 0; i < busy_time.length; i++) {
            var d = new Date(busy_time[i]);
            busy_date.push(d);

        }

        console.log(busy_date)

        // var $input = $( '.datepicker' ).pickatime({
        //     clear : ""
        //     // max: [22,0]
        // })
        var $input = $('.datepicker').pickatime({
            format: 'HH:i',
            formatLabel: '<b>HH</b>:i',
            formatSubmit: 'HH:i',
            interval: 1,
            // disable: busy_date,
            min: addMinutes(new Date, 6),

            // max: [22,0]
        })
        var picker = $input.pickatime('picker')
        // picker.set('select', [3,0])
        var d = new Date(); // for now
        var h = d.getHours(); // => 9
        var m = d.getMinutes(); // =>  30
        var s = d.getSeconds(); //
        picker.set('select', h + '-' + m, { format: 'HH-i' })

        picker.set('enable', true);
        picker.set('disable', busy_date)
        // console.log(picker.get())
    }

    function setup_terminal_select() {
        document.getElementById("terminal-list").onchange = function() {
            var terminal_id = this.value;
            var busy_time = get_busy_time(terminal_id)
            // console.log(busy_time)
            setup_time_picker(busy_time)
        };

        function selectElement(id, valueToSelect) {
            var sel = document.getElementById(id);
            var opt = document.createElement('option');

            // create text node to add to option element (opt)
            opt.appendChild(document.createTextNode(valueToSelect));

            // set value property of opt
            opt.value = valueToSelect;

            // add opt to end of select box (sel)
            sel.appendChild(opt);
            // document.getElementById(id).appendChild( document.createTextNode(valueToSelect) )

        }

        selectElement('terminal-list', '2')
        selectElement('terminal-list', '3')
        selectElement('terminal-list', '5')


    }

    function set_error_message(text) {
        var m = document.getElementById("error-message")
        m.style.visibility = "visible";
        if (text == "") {
            m.style.visibility = "hidden";
        }
        m.innerHTML = text;

    }

    function get_print_time() {
        // var TIME_ZONE_PLUS = 2
        var time = $(".datepicker").val()
        var d = new Date(); // for now
        d.setHours(parseInt(time.substring(0, 2)))
        d.setMinutes(time.substring(3, 5))
        return d.toISOString().substring(0, 19)
    }

    function feel_dropdown(data) {
        // console.log(text)
        // var data = JSON.parse(text);

        $("#user-info-dropmenu").append('<li class="list-group-item">Username<br>' + data["username"] + '</li>');
        $("#user-info-dropmenu").append('<li class="list-group-item">Email<br>' + data["email"] + '</li>');
        // $("#user-info-dropmenu").append('<li class="list-group-item">Phone Number<br>' + data["numberphone"] + '</li>');
        $("#user-info-dropmenu").append('<li class="list-group-item">Pages<br>' + data["numberpages"] + '</li>');
        var m = document.getElementById("pages-message")
        m.innerHTML = "You have " + data["numberpages"] + " pages";

    }

    function setup_dropdown() {
        $.ajax({
            url: 'https://api2.drukbox.club/api/getshortuserinfo',
            type: 'GET',
            async: false,
            cache: false,
            contentType: false,
            enctype: 'multipart/form-data',
            processData: false,
            success: function(response) {
                // console.log(response);
                var obj = JSON.parse(response)
                // remove_form()
                console.log(obj)
                if (obj.status === "ok") {
                    feel_dropdown(obj.data)
                } else {
                    set_error_message(obj.status_description)
                    set_success_message("")
                }
            },
            xhrFields: { withCredentials: true }
        });
    }

    function submit_form() {
        start_timer_bar()
        try {
            var fileInfo = new Object();
            fileInfo.printingdate = get_print_time()
            fileInfo.idprinter = parseInt($("#terminal-list").val());
            fileInfo.filename = $("#_attachmentName").val();
            if (fileInfo.filename == "") {
                set_error_message("Please check file")
                return
            }

            var json = JSON.stringify(fileInfo);
            var fileInput = document.getElementById('attachmentName');
            var file = fileInput.files[0];
            var formData = new FormData();
            formData.append('json', json);
            formData.append('uploadfile', file);
        } catch (e) {
            set_error_message("Please feel form correctly")
            set_success_message("")
            delete_timer_bar()
            return
        }

        $.ajax({
            url: 'https://api2.drukbox.club/api/uploadfile',
            type: 'POST',
            data: formData,
            async: true,
            cache: false,
            contentType: false,
            enctype: 'multipart/form-data',
            processData: false,
            success: function(response) {
                // console.log(response);
                var obj = JSON.parse(response)
                // remove_form()
                console.log(obj)
                if (obj.status === "ok") {
                    set_error_message("")
                    set_success_message(obj.status_description)
                    delete_timer_bar()
                } else {
                    set_error_message(obj.status_description)
                    set_success_message("")
                    delete_timer_bar()
                }
            },
            error: function(request, status, error) {
                set_error_message("Sorry but your file is not uploaded, please try again or try convert to other format")
                set_success_message("")
                delete_timer_bar()
            },
            xhrFields: { withCredentials: true }

        });

    }

    function get_busy_time(terminal_id) {
        var result = []
        $.ajax({
            url: 'https://api2.drukbox.club/api/busytime',
            type: 'GET',
            async: false,
            cache: false,
            contentType: false,
            enctype: 'multipart/form-data',
            processData: false,
            success: function(response) {
                // console.log(response);
                // console.log(response)

                var obj = JSON.parse(response)
                // remove_form()
                console.log(obj)
                if (obj.status === "ok") {
                    var data = obj.data;
                    data.forEach(function(file) {
                        if (terminal_id == file["IdPrinter"]) {
                            // console.log(file["PrintingDate"]);
                            result.push(file["PrintingDate"] + "Z")
                            return (result)
                        }

                    });
                } else {
                    set_error_message(obj.status_description)
                    set_success_message("")
                }
            },
            xhrFields: { withCredentials: true }
        });
        return result
    }


    setup_terminal_select()
    set_error_message("")
    set_success_message("")
    // setup_from()
    setup_dropdown()
    // start_timer_bar()
    </script>
    <script>
    $('.custom-file-input').on('change', function() {
        let fileName = $(this).val().split('\\').pop();
        $(this).siblings('.custom-file-label').addClass('selected').html(fileName);
    });
    $(function() {
        $("#datetimepicker1").datetimepicker({
            disabledHours: [0, 1, 2, 3, 4, 5, 6, 20, 21, 22, 23, 24],
            startDate: '2016/08/19 10:00',

        });
    });
    </script>
    <script>
    var fileExtentionRange = '.pdf .doc .docx .odt .ott';
    var MAX_SIZE = 3; // MB

    $(document).on('change', '.btn-file :file', function() {
        var input = $(this);

        if (navigator.appVersion.indexOf("MSIE") != -1) { // IE
            var label = input.val();

            input.trigger('fileselect', [1, label, 0]);
        } else {
            var label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
            var numFiles = input.get(0).files ? input.get(0).files.length : 1;
            var size = input.get(0).files[0].size;

            input.trigger('fileselect', [numFiles, label, size]);
        }
    });

    $('.btn-file :file').on('fileselect', function(event, numFiles, label, size) {
        $('#attachmentName').attr('name', 'attachmentName'); // allow upload.

        var postfix = label.substr(label.lastIndexOf('.'));
        if (fileExtentionRange.indexOf(postfix.toLowerCase()) > -1) {
            if (size > 1024 * 1024 * MAX_SIZE) {
                alert('max size：<strong>' + MAX_SIZE + '</strong> MB.');

                $('#attachmentName').removeAttr('name'); // cancel upload file.
            } else {
                $('#_attachmentName').val(label);
            }
        } else {
            set_error_message('Please upload file which have one of this types: <br/> <strong>' + fileExtentionRange + '</strong>');
            set_success_message("")

            $('#attachmentName').removeAttr('name'); // cancel upload file.
        }
    });
    </script>
</body>

</html>